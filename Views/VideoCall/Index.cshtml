@{
    ViewData["Title"] = "Video Call";
    Layout = null; // No layout for full-screen video call
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="icon" href="~/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #root {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .loading-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            margin-bottom: 10px;
        }

        .loading-subtitle {
            font-size: 14px;
            opacity: 0.8;
            text-align: center;
        }

        .error-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            z-index: 2000;
        }

        .error-icon {
            color: #e74c3c;
            font-size: 48px;
            margin-bottom: 20px;
        }

        .error-title {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .error-message {
            color: #7f8c8d;
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s ease;
        }

            .btn:hover {
                background: #2980b9;
            }

        .btn-secondary {
            background: #95a5a6;
            margin-left: 10px;
        }

            .btn-secondary:hover {
                background: #7f8c8d;
            }

        /* Hide the loading container when video call starts */
        .call-started .loading-container {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <div class="loading-text">Connecting to video call...</div>
        <div class="loading-subtitle">Please wait while we set up your connection</div>
    </div>

    <!-- Main Video Call Container -->
    <div id="root"></div>

    <!-- Error Container (hidden by default) -->
    <div class="error-container" id="errorContainer" style="display: none;">
        <div class="error-icon">⚠️</div>
        <div class="error-title">Connection Failed</div>
        <div class="error-message" id="errorMessage">
            Unable to connect to the video call. Please check your internet connection and try again.
        </div>
        <a href="javascript:void(0)" onclick="retryConnection()" class="btn">Try Again</a>
        <a href="/" class="btn btn-secondary">Go Home</a>
    </div>

    <!-- Hidden input for user information -->
    <input type="hidden" id="currentUserId" value="@User.FindFirst("UserId")?.Value" />

    <!-- Scripts -->
    <script src="~/js/signalr/dist/browser/signalr.min.js"></script>
    <script src="https://unpkg.com/%40zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
    <script>
        // Global variables
        let connection = null;
        let currentRoomId = null;
        let currentUserId = null;
        let userName = null;
        let callInitialized = false;
        let hasJoinedRoom = false;
        let joinTimeout = null;

        // Initialize the video call
        window.onload = function () {
            try {
                initializeCall();
            } catch (error) {
                console.error("❌ Error initializing call:", error);
                showError("Failed to initialize video call", error.message);
            }
        };

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function initializeCall() {
            // Get room and user information
            currentRoomId = getQueryParam("room") || localStorage.getItem("roomID");
            currentUserId = getQueryParam("user") ||
                          document.getElementById("currentUserId").value ||
                          localStorage.getItem("userId");

            console.log("🎥 Room ID:", currentRoomId);
            console.log("👤 User ID:", currentUserId);

            if (!currentRoomId) {
                showError("Invalid Room", "No room ID provided. Please use a valid call link.");
                return;
            }

            if (!currentUserId) {
                showError("Authentication Required", "Please log in to join the video call.");
                return;
            }

            // Store room ID for later use
            localStorage.setItem("roomID", currentRoomId);

            // Initialize SignalR connection first
            initializeSignalR();
        }

        function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .build();

            connection.start().then(function () {
                console.log("✅ SignalR connected for video call");

                // Join user channel
                connection.invoke("JoinUserChannel", currentUserId);

                // Listen for call events - but only after we've successfully joined
                connection.on("CallEnded", function (data) {
                    console.log("📵 Call ended by remote user");
                    if (hasJoinedRoom) {
                        handleCallEnded();
                    } else {
                        console.log("🔄 Ignoring CallEnded - not yet joined room");
                    }
                });

                connection.on("CallAccepted", function (data) {
                    console.log("✅ Call was accepted");
                });

                connection.on("CallRejected", function (data) {
                    console.log("❌ Call was rejected");
                    showError("Call Rejected", "The other user declined your call.");
                });

                // After SignalR is connected, fetch user data and start the video call
                fetchUserAndStartCall();

            }).catch(function (err) {
                console.error("❌ SignalR connection error:", err);
                // Still try to start the call even if SignalR fails
                fetchUserAndStartCall();
            });
        }

        function fetchUserAndStartCall() {
            fetch(`/api/user/${currentUserId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch user data (Status: ${response.status})`);
                    }
                    return response.json();
                })
                .then(user => {
                    userName = `${user.first_name || ""} ${user.last_name || ""}`.trim() || `User ${currentUserId}`;
                    console.log("👤 User name:", userName);

                    // Start the video call
                    startVideoCall();
                })
                .catch(error => {
                    console.error("❌ Error fetching user data:", error);
                    // Use fallback name and continue
                    userName = `User ${currentUserId}`;
                    startVideoCall();
                });
        }

        function startVideoCall() {
            if (callInitialized) {
                console.log("⚠️ Call already initialized");
                return;
            }

            callInitialized = true;

            try {
                // ZegoCloud configuration
                const appID = 1819674491; // Your actual App ID
                const serverSecret = "29dc1c47b85cfbf7587b7f2eb80d3dcd"; // Your actual Server Secret

                // Generate kit token
                const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(
                    appID,
                    serverSecret,
                    currentRoomId,
                    currentUserId,
                    userName
                );

                console.log("🔑 Kit token generated successfully");

                // Create ZegoUIKitPrebuilt instance
                const zp = ZegoUIKitPrebuilt.create(kitToken);

                // Configure and join room
                zp.joinRoom({
                    container: document.querySelector("#root"),
                    sharedLinks: [{
                        name: 'Share Call Link',
                        url: `${window.location.protocol}//${window.location.host}/video-call?room=${currentRoomId}`,
                    }],
                    scenario: {
                        mode: ZegoUIKitPrebuilt.VideoConference,
                    },
                    showPreJoinView: false,
                    turnOnMicrophoneWhenJoining: false,
                    turnOnCameraWhenJoining: false,
                    showMyCameraToggleButton: true,
                    showMyMicrophoneToggleButton: true,
                    showAudioVideoSettingsButton: true,
                    showScreenSharingButton: true,
                    showTextChat: true,
                    showUserList: true,
                    maxUsers: 50,
                    layout: "Auto",
                    showLayoutButton: true,

                    // Callback events
                    onJoinRoom: () => {
                        console.log("✅ Successfully joined the room");
                        hasJoinedRoom = true;
                        hideLoading();

                        // Clear the join timeout since we successfully joined
                        if (joinTimeout) {
                            clearTimeout(joinTimeout);
                            joinTimeout = null;
                        }
                    },

                    onLeaveRoom: () => {
                        console.log("📤 Left the room");
                        // Only handle call end if we actually joined first
                        if (hasJoinedRoom) {
                            handleCallEnded();
                        } else {
                            console.log("🔄 onLeaveRoom called but never joined - likely connection issue");
                            showError("Connection Failed", "Failed to connect to the video call room. Please check your internet connection and try again.");
                        }
                    },

                    onUserJoin: (users) => {
                        console.log("👥 Users joined:", users);
                        hideLoading(); // Hide loading when other users join
                    },

                    onUserLeave: (users) => {
                        console.log("👋 Users left:", users);
                    }
                });

                // Set a timeout to detect failed joins
                joinTimeout = setTimeout(() => {
                    if (!hasJoinedRoom) {
                        console.log("⏰ Join timeout - connection failed");
                        showError("Connection Timeout", "Failed to join the video call within the expected time. Please check your internet connection and try again.");
                    }
                }, 15000); // 15 seconds timeout

                // Hide loading after a reasonable timeout even if onJoinRoom doesn't fire
                setTimeout(() => {
                    hideLoading();
                }, 10000);

            } catch (error) {
                console.error("❌ Error starting video call:", error);
                showError("Video Call Failed", "Unable to start the video call. Please try again.");
            }
        }

        function hideLoading() {
            const loadingContainer = document.getElementById("loadingContainer");
            if (loadingContainer) {
                loadingContainer.style.display = "none";
            }
            document.body.classList.add("call-started");
        }

        function showError(title, message) {
            hideLoading();
            const errorContainer = document.getElementById("errorContainer");
            const errorMessage = document.getElementById("errorMessage");

            document.querySelector(".error-title").textContent = title;
            errorMessage.textContent = message;
            errorContainer.style.display = "block";
        }

        function retryConnection() {
            document.getElementById("errorContainer").style.display = "none";
            document.getElementById("loadingContainer").style.display = "flex";

            // Reset state
            callInitialized = false;
            hasJoinedRoom = false;
            if (joinTimeout) {
                clearTimeout(joinTimeout);
                joinTimeout = null;
            }

            // Retry after a short delay
            setTimeout(() => {
                initializeCall();
            }, 1000);
        }

        function handleCallEnded() {
            // Prevent multiple calls
            if (handleCallEnded.called) {
                return;
            }
            handleCallEnded.called = true;

            console.log("🔚 Handling call end");

            // Clean up and redirect
            if (connection && connection.state === "Connected") {
                connection.stop();
            }

            // Clear stored room ID
            localStorage.removeItem("roomID");

            // Clear any timeouts
            if (joinTimeout) {
                clearTimeout(joinTimeout);
            }

            // Show goodbye message and redirect
            alert("The video call has ended.");

        }

        // Handle page visibility change
        document.addEventListener("visibilitychange", function() {
            if (document.visibilityState === 'hidden') {
                console.log("📱 Page hidden");
            } else {
                console.log("📱 Page visible");
            }
        });

        // Handle before unload
        window.addEventListener("beforeunload", function(e) {
            if (connection && connection.state === "Connected") {
                // Just disconnect cleanly
                connection.stop();
            }

            // Clear any timeouts
            if (joinTimeout) {
                clearTimeout(joinTimeout);
            }
        });

        // Clean up on page unload
        window.addEventListener("unload", function() {
            if (connection) {
                connection.stop();
            }
            localStorage.removeItem("roomID");

            if (joinTimeout) {
                clearTimeout(joinTimeout);
            }
        });
    </script>
</body>
</html>